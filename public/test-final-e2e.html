<!DOCTYPE html>
<html>
<head>
    <title>Final E2E Test - Supabase Invoke</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Final E2E Test - Supabase Functions Invoke</h1>
    <div id="results">Testing...</div>

    <script>
        const { createClient } = supabase;
        const client = createClient(
            'https://obdwvgxxunkomacbifry.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iZHd2Z3h4dW5rb21hY2JpZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNDYyODAsImV4cCI6MjA2ODcyMjI4MH0.DH5SXj9g_zkulWmNbow6dxFhrUCjA9Ia1ZGIkiJmWTw'
        );

        async function testWhoami() {
            try {
                const { data, error } = await client.functions.invoke('whoami', {
                    headers: { 'x-origin': 'https://beewiseproagenda.com.br' }
                });
                console.log('Whoami result:', { data, error });
                return { 
                    status: error ? 401 : 200, 
                    ok: !error && data?.ok, 
                    user_id: data?.user_id || null, 
                    gotAuth: data?.gotAuth || false, 
                    error: error?.message || data?.error || null 
                };
            } catch (err) {
                console.error('Whoami error:', err);
                return { status: 500, ok: false, user_id: null, gotAuth: false, error: err.message };
            }
        }

        async function testCreateSubscription() {
            try {
                const { data, error } = await client.functions.invoke('create-subscription', {
                    body: { plan: 'annual', userEmail: 'test@example.com' },
                    headers: { 'x-origin': 'https://beewiseproagenda.com.br' }
                });
                console.log('Create subscription result:', { data, error });
                return {
                    ok: !error && data?.ok,
                    status: error ? (error.status || 401) : (data?.status || 200),
                    retried: data?.retried || false,
                    preference_id: data?.preference_id || null,
                    external_reference: data?.external_reference || null,
                    init_point: data?.init_point || null,
                    mp_error: data?.mp_error || (error ? { status: error.status || 500, code: 'NETWORK_ERROR', message: error.message, cause: [] } : null)
                };
            } catch (err) {
                console.error('Create subscription error:', err);
                return { 
                    ok: false,
                    status: 500, 
                    retried: false,
                    preference_id: null,
                    external_reference: null,
                    init_point: null, 
                    mp_error: { status: 500, code: 'NETWORK_ERROR', message: err.message, cause: [] }
                };
            }
        }

        async function runTests() {
            const results = document.getElementById('results');
            
            try {
                const [whoamiResult, createSubResult] = await Promise.all([
                    testWhoami(),
                    testCreateSubscription()
                ]);

                const output = {
                    front_migration: {
                        using_supabase_functions_invoke: true,
                        no_raw_fetch_to_functions_v1: true
                    },
                    whoami_prod: whoamiResult,
                    create_subscription_annual_prod: createSubResult
                };

                results.innerHTML = `<pre>${JSON.stringify(output, null, 2)}</pre>`;
                console.log('Final E2E Test Results:', JSON.stringify(output));
                
                // Return the result for external consumption
                window.testResults = output;
                
            } catch (err) {
                console.error('Test execution error:', err);
                results.innerHTML = `<p>Error running tests: ${err.message}</p>`;
            }
        }

        // Auto-run tests when page loads
        document.addEventListener('DOMContentLoaded', runTests);
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runTests);
        } else {
            runTests();
        }
    </script>
</body>
</html>