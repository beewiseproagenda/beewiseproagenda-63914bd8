<!DOCTYPE html>
<html>
<head>
    <title>Teste E2E Real</title>
</head>
<body>
    <h1>Teste E2E - Real Session Test</h1>
    
    <button id="testBtn" onclick="runRealTest()">Executar Teste Real</button>
    <div id="status">Clique no botão para iniciar</div>
    <pre id="result"></pre>
    
    <script>
        async function runRealTest() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            const testBtn = document.getElementById('testBtn');
            
            testBtn.disabled = true;
            statusDiv.textContent = 'Executando teste...';
            resultDiv.textContent = '';
            
            try {
                // 1. Primeiro teste: diag-env
                statusDiv.textContent = 'Testando diag-env...';
                const diagResp = await fetch('https://obdwvgxxunkomacbifry.supabase.co/functions/v1/diag-env');
                const diagJson = await diagResp.json();
                
                resultDiv.textContent += '=== TESTE 1: DIAG-ENV ===\n';
                resultDiv.textContent += JSON.stringify(diagJson, null, 2) + '\n\n';
                
                // 2. Teste com token Supabase anon (simula usuário não autenticado)
                statusDiv.textContent = 'Testando create-subscription com token anon...';
                const anonToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iZHd2Z3h4dW5rb21hY2JpZnJ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxNDYyODAsImV4cCI6MjA2ODcyMjI4MH0.DH5SXj9g_zkulWmNbow6dxFhrUCjA9Ia1ZGIkiJmWTw';
                
                const anonResp = await fetch('https://obdwvgxxunkomacbifry.supabase.co/functions/v1/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${anonToken}`
                    },
                    body: JSON.stringify({
                        plan: 'annual',
                        userEmail: 'felipegamerptbr@gmail.com' // Use o e-mail de um usuário real
                    })
                });
                
                const anonText = await anonResp.text();
                let anonJson = {};
                try {
                    anonJson = anonText ? JSON.parse(anonText) : {};
                } catch {
                    anonJson = { raw_response: anonText };
                }
                
                resultDiv.textContent += '=== TESTE 2: ANON TOKEN (expected 401) ===\n';
                resultDiv.textContent += `Status: ${anonResp.status}\n`;
                resultDiv.textContent += `Headers: ${JSON.stringify(Object.fromEntries(anonResp.headers.entries()), null, 2)}\n`;
                resultDiv.textContent += `Body: ${JSON.stringify(anonJson, null, 2)}\n\n`;
                
                // 3. Teste com token fake de usuário (simula usuário com JWT inválido)
                statusDiv.textContent = 'Testando create-subscription com token fake de usuário...';
                const fakeUserToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iZHd2Z3h4dW5rb21hY2JpZnJ5Iiwicm9sZSI6ImF1dGhlbnRpY2F0ZWQiLCJpYXQiOjE3NTMxNDYyODAsImV4cCI6MjA2ODcyMjI4MCwidXNlcl9pZCI6IjEyMzQ1Njc4LTkwYWItY2RlZi0xMjM0LTU2Nzg5MGFiY2RlZiIsImVtYWlsIjoiZmVsaXBlZ2FtZXJwdGJyQGdtYWlsLmNvbSJ9.FAKE_SIGNATURE';
                
                const fakeResp = await fetch('https://obdwvgxxunkomacbifry.supabase.co/functions/v1/create-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${fakeUserToken}`
                    },
                    body: JSON.stringify({
                        plan: 'annual',
                        userEmail: 'felipegamerptbr@gmail.com'
                    })
                });
                
                const fakeText = await fakeResp.text();
                let fakeJson = {};
                try {
                    fakeJson = fakeText ? JSON.parse(fakeText) : {};
                } catch {
                    fakeJson = { raw_response: fakeText };
                }
                
                resultDiv.textContent += '=== TESTE 3: FAKE USER TOKEN (expected 401) ===\n';
                resultDiv.textContent += `Status: ${fakeResp.status}\n`;
                resultDiv.textContent += `Body: ${JSON.stringify(fakeJson, null, 2)}\n\n`;
                
                // 4. Teste CORS
                statusDiv.textContent = 'Testando CORS (OPTIONS)...';
                const corsResp = await fetch('https://obdwvgxxunkomacbifry.supabase.co/functions/v1/create-subscription', {
                    method: 'OPTIONS'
                });
                
                resultDiv.textContent += '=== TESTE 4: CORS/OPTIONS ===\n';
                resultDiv.textContent += `Status: ${corsResp.status}\n`;
                resultDiv.textContent += `Headers: ${JSON.stringify(Object.fromEntries(corsResp.headers.entries()), null, 2)}\n\n`;
                
                statusDiv.textContent = 'Todos os testes concluídos!';
                
            } catch (error) {
                resultDiv.textContent += `\nERRO GERAL: ${error.message}\n`;
                statusDiv.textContent = 'Erro durante os testes!';
            } finally {
                testBtn.disabled = false;
            }
        }
    </script>
</body>
</html>